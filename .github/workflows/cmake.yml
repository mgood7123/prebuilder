name: CMake

on:
  push:
    branches: [ main ]

concurrency:
  group: build
  cancel-in-progress: true

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Debug
  
  # Customize the build folder here
  # IMPORTANT: this MUST NOT conflict with any existing folders
  
  GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER: GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER

  # Customize the output folder here
  # IMPORTANT: this MUST NOT conflict with any existing folders
  
  GITHUB_ACTIONS_PREBUILD_OUT_FOLDER: GITHUB_ACTIONS_PREBUILD_OUT_FOLDER

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
        
        - os: ubuntu-latest
          extension: so
          out: ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/ubuntu-latest
          listLibs: find ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -name \*.so
          copyLibs: find ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -name \*.so -exec cp -v {} ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/ubuntu-latest/ \;
          rm: rm -rf ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}}
          
        - os: macOS-latest
          extension: dylib
          out: ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/macOS-latest
          listLibs: find ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -name \*.dylib
          copyLibs: find ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -name \*.dylib -exec cp -v {} ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/macOS-latest/ \;
          rm: rm -rf ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}}
          
        - os: windows-latest
          extension: dll
          out: ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/windows-latest
          listLibs: Get-ChildItem -path ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -r -filter *.dll
          copyLibs: Get-ChildItem -path ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -r -filter *.dll | Copy-Item -v -Destination ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/windows-latest/
          rm: Remove-Item -Recurse -Force ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}}

    steps:
    - uses: actions/checkout@v2
    
    - name: pull
      run: |
        git pull
        git status

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        cmake -D GITHUB_ACTIONS_PREBUILD_EXTENSION=${{matrix.extension}} -B ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
        git status

    - name: Build
      # Build your program with the given configuration
      run: |
        cmake --build ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} --config ${{env.BUILD_TYPE}}
        git status
      
    - name: list libs
      run: |
        ${{matrix.listLibs}}
        git status
      
    - name: git config global
      run: |
        git config --global user.email "GITHUB_ACTIONS_PREBUILD";
        git config --global user.name "GITHUB_ACTIONS_PREBUILD"
        git status
        
    - name: mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}
      continue-on-error: true
      run: |
        mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}
        git status
        
    - name: mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}
      continue-on-error: true
      run: |
        mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}
        git status

    - name: copy files
      run: |
        ${{matrix.copyLibs}}
        git status
        
    - name: rm build
      run: |
        ${{matrix.rm}}
        git status
      
    - name: add prebuilt
      run: |
        git add -Av ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}
        git status
        
    - name: commit
      continue-on-error: true
      run: |
        git commit -m "push prebuilts for ${{matrix.os}}"
        git status
        
    - name: push
      run: |
        git push
        git status
