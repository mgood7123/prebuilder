name: CMake

on:
  push:
    branches: [ main ]

concurrency:
  group: build
  cancel-in-progress: true

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Debug
  
  # Customize the build folder here
  # IMPORTANT: this MUST NOT conflict with any existing folders
  
  GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER: GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER

  # Customize the output folder here
  # IMPORTANT: this MUST NOT conflict with any existing folders
  
  GITHUB_ACTIONS_PREBUILD_OUT_FOLDER: GITHUB_ACTIONS_PREBUILD_OUT_FOLDER

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
        
        - os: ubuntu-latest
          extension: so
          listLibs_S: find
          listLibs_E: -name \*
          pipe: ${{null}}
          copyLibs_S: -exec cp -v {}
          copyLibs_E: \;
          rm: rm -rf
          
        - os: macOS-latest
          extension: dylib
          listLibs_S: find
          listLibs_E: -name \*
          pipe: ${{null}}
          copyLibs_S: -exec cp -v {}
          copyLibs_E: \;
          rm: rm -rf

        - os: windows-latest
          extension: dll
          listLibs_S: Get-ChildItem -path
          listLibs_E: -r -filter *
          pipe: \|
          copyLibs_S: Copy-Item -v -Destination
          copyLibs_E: ${{null}}
          rm: Remove-Item -Recurse -Force

    steps:
    - uses: actions/checkout@v2
    
    - name: pull
      run: |
        git pull
        git status

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        cmake -D GITHUB_ACTIONS_PREBUILD_EXTENSION=${{matrix.extension}} -B ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
        git status

    - name: Build
      # Build your program with the given configuration
      run: |
        cmake --build ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} --config ${{env.BUILD_TYPE}}
        git status
      
    - name: list libs
      run: |
        ${{matrix.listLibs_S}} ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} ${{matrix.listLibs_E}}.${{matrix.extension}}
        git status
      
    - name: git config global
      run: |
        git config --global user.email "GITHUB_ACTIONS_PREBUILD";
        git config --global user.name "GITHUB_ACTIONS_PREBUILD"
        git status
        
    - name: mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}
      continue-on-error: true
      run: |
        mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}
        git status
        
    - name: mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}
      continue-on-error: true
      run: |
        mkdir ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}
        git status

    - name: copy files
      run: |
        ${{matrix.listLibs_S}} ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}} ${{matrix.listLibs_E}}.${{matrix.extension}} ${{matrix.pipe}} ${{matrix.copyLibs_S}} ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}/ ${{matrix.copyLibs_E}}
        git status
      if: matrix.os != 'windows-latest'
        
    - name: rm build
      run: |
        ${{matrix.rm}} ${{env.GITHUB_ACTIONS_PREBUILD_BUILD_FOLDER}}
        git status
      
    - name: add prebuilt
      run: |
        git add -Av ${{env.GITHUB_ACTIONS_PREBUILD_OUT_FOLDER}}/${{matrix.os}}
        git status
        
    - name: commit
      continue-on-error: true
      run: |
        git commit -m "push prebuilts for ${{matrix.os}}"
        git status
        
    - name: push
      run: |
        git push
        git status
